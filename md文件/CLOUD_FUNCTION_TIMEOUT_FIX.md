# 云函数超时问题解决方案

## 问题

云函数报错：`Invoking task timed out after 3 seconds`

这是因为：
1. 微信云开发**默认超时时间是 3 秒**
2. 调用 Kimi API 通常需要 5-20 秒
3. 云函数在 3 秒内无法完成，被强制终止

## 解决方案

### 方案 1：在云开发控制台增加超时时间（必须）

1. **打开云开发控制台**
   - 微信开发者工具 → 点击 **"云开发"** 按钮

2. **进入云函数配置**
   - 左侧菜单 → **"云函数"** → **"aiChat"**
   - 点击 **"配置"** 标签

3. **修改超时时间**
   - 找到 **"超时时间"** 设置
   - 将超时时间改为 **30 秒**（或更长，最大 60 秒）
   - 点击 **"保存"**

4. **重新部署云函数**
   - 右键 `cloudfunctions/aiChat` 文件夹
   - 选择 **"上传并部署：云端安装依赖"**

### 方案 2：代码优化（已完成）

我已经优化了代码：
- ✅ 添加了 HTTP 请求超时控制（25秒）
- ✅ 限制了 AI 输出长度（`max_tokens: 200`）
- ✅ 简化了系统提示词，加快响应速度

### 方案 3：使用更快的模型（可选）

如果 `kimi-k2-0905-preview` 太慢，可以尝试：
- `moonshot-v1-8k`（更快，但能力稍弱）
- 在 `config.js` 中修改 `MOONSHOT_MODEL`

## 验证

配置完成后：
1. 重新上传云函数
2. 在小程序中测试对话
3. 查看云函数日志，确认不再超时

## 注意事项

⚠️ **重要**：
- 云函数超时时间必须在云开发控制台配置，不能通过代码设置
- 免费版云开发可能有超时限制，如果 30 秒还不够，考虑升级套餐
- 建议将超时时间设置为 30-60 秒

## 如果还是超时

1. **检查网络**：确认云函数能正常访问 `api.moonshot.cn`
2. **检查 API Key**：确认 Key 有效且有足够额度
3. **查看详细日志**：云开发控制台 → 云函数 → 日志，查看具体错误
4. **尝试简化请求**：减少对话历史长度，简化提示词

