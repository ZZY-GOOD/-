{"version":3,"file":"profile.js","sources":["pages/profile/profile.vue","../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcHJvZmlsZS9wcm9maWxlLnZ1ZQ"],"sourcesContent":["<template>\n\t<view class=\"page\">\n\t\t<!-- 顶部个人信息展示 -->\n\t\t<view class=\"profile-card\">\n\t\t\t<image class=\"avatar\" :src=\"avatar\" mode=\"aspectFill\" />\n\t\t\t<view class=\"profile-info\">\n\t\t\t\t<text class=\"name\">{{ nickname || '未命名用户' }}</text>\n\t\t\t</view>\n\t\t\t<!-- 清除数据按钮（测试用） -->\n\t\t\t<view class=\"clear-btn\" @click=\"clearUserData\">清除登录</view>\n\t\t</view>\n\n\t\t<!-- 数据卡片（仅展示） -->\n\t\t<view class=\"stats-card\">\n\t\t\t<view class=\"stats-title\">挑战数据</view>\n\t\t\t<view class=\"stats-row\">\n\t\t\t\t<view class=\"stat-item\">\n\t\t\t\t\t<text class=\"stat-value\">{{ stats.totalGames }}</text>\n\t\t\t\t\t<text class=\"stat-label\">总挑战</text>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"stat-item\">\n\t\t\t\t\t<text class=\"stat-value\">{{ stats.successCount }}</text>\n\t\t\t\t\t<text class=\"stat-label\">成功次数</text>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"stat-item\">\n\t\t\t\t\t<text class=\"stat-value\">{{ stats.successRate }}%</text>\n\t\t\t\t\t<text class=\"stat-label\">成功率</text>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"stat-item\">\n\t\t\t\t\t<text class=\"stat-value\">{{ stats.uniqueScenes }}</text>\n\t\t\t\t\t<text class=\"stat-label\">玩过场景</text>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<!-- 挑战记录（展示） -->\n\t\t<view class=\"records-card\">\n\t\t\t<view class=\"records-title\">最近挑战</view>\n\t\t\t<view v-if=\"records.length === 0\" class=\"empty\">暂无记录</view>\n\t\t\t<view\n\t\t\t\tv-else\n\t\t\t\tclass=\"record-item\"\n\t\t\t\tv-for=\"(rec, idx) in records\"\n\t\t\t\t:key=\"idx\"\n\t\t\t\t@click=\"handleRecordClick(rec)\"\n\t\t\t>\n\t\t\t\t<view class=\"record-main\">\n\t\t\t\t\t<view class=\"rec-top\">\n\t\t\t\t\t\t<text class=\"rec-title\">{{ rec.sceneTitle || '未知场景' }}</text>\n\t\t\t\t\t\t<text class=\"rec-result\" :class=\"rec.is_success ? 'ok' : 'fail'\">\n\t\t\t\t\t\t\t{{ rec.is_success ? '成功' : '失败' }}\n\t\t\t\t\t\t</text>\n\t\t\t\t\t</view>\n\t\t\t\t\t<view class=\"rec-sub\">\n\t\t\t\t\t\t<text>原谅值：{{ rec.final_forgiveness ?? '--' }}</text>\n\t\t\t\t\t\t<text>轮次：{{ rec.interaction_count ?? '--' }}</text>\n\t\t\t\t\t\t<text>{{ rec.created_at ? rec.created_at.split('T')[0] : '' }}</text>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"rec-action\">\n\t\t\t\t\t<text class=\"rec-cta\">再挑战</text>\n\t\t\t\t\t<text class=\"rec-arrow\">›</text>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<!-- 底部选择弹窗 -->\n\t\t<view v-if=\"showBottomSheet\" class=\"bottom-sheet-mask\" @click=\"closeBottomSheet\">\n\t\t\t<view class=\"bottom-sheet\" @click.stop>\n\t\t\t\t<view class=\"sheet-title\">{{ bottomSheetTitle }}</view>\n\t\t\t\t<view class=\"sheet-options\">\n\t\t\t\t\t<view \n\t\t\t\t\t\tv-for=\"(option, index) in bottomSheetOptions\" \n\t\t\t\t\t\t:key=\"index\"\n\t\t\t\t\t\tclass=\"sheet-option\"\n\t\t\t\t\t\t@click=\"handleBottomOption(index)\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<image v-if=\"option.avatar\" class=\"option-avatar\" :src=\"option.avatar\" mode=\"aspectFill\" />\n\t\t\t\t\t\t<text class=\"option-text\">{{ option.text }}</text>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"sheet-cancel\" @click=\"closeBottomSheet\">取消</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<!-- 输入昵称弹窗 -->\n\t\t<view v-if=\"showNameInput\" class=\"modal-mask\" @click=\"closeNameInput\">\n\t\t\t<view class=\"modal\" @click.stop>\n\t\t\t\t<view class=\"modal-title\">输入昵称</view>\n\t\t\t\t<input class=\"modal-input\" v-model=\"inputName\" placeholder=\"请输入昵称\" maxlength=\"20\" />\n\t\t\t\t<view class=\"modal-actions\">\n\t\t\t\t\t<button size=\"mini\" @click=\"closeNameInput\">取消</button>\n\t\t\t\t\t<button size=\"mini\" type=\"primary\" @click=\"confirmNameInput\">确认</button>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<!-- 微信一键登录弹窗（使用新组件方式） -->\n\t\t<view v-if=\"showWxLoginModal\" class=\"modal-mask\" @click=\"closeWxLoginModal\">\n\t\t\t<view class=\"modal wx-login-modal\" @click.stop>\n\t\t\t\t<view class=\"modal-title\">微信一键登录</view>\n\t\t\t\t<view class=\"wx-login-content\">\n\t\t\t\t\t<!-- 选择头像 -->\n\t\t\t\t\t<view class=\"wx-login-item\">\n\t\t\t\t\t\t<text class=\"wx-login-label\">选择头像</text>\n\t\t\t\t\t\t<!-- #ifdef MP-WEIXIN -->\n\t\t\t\t\t\t<button class=\"wx-avatar-btn\" open-type=\"chooseAvatar\" @chooseavatar=\"onChooseAvatar\">\n\t\t\t\t\t\t\t<image v-if=\"tempAvatar\" class=\"wx-avatar-preview\" :src=\"tempAvatar\" mode=\"aspectFill\" />\n\t\t\t\t\t\t\t<view v-else class=\"wx-avatar-placeholder\">\n\t\t\t\t\t\t\t\t<text>点击选择头像</text>\n\t\t\t\t\t\t\t</view>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<!-- #endif -->\n\t\t\t\t\t</view>\n\t\t\t\t\t<!-- 输入昵称 -->\n\t\t\t\t\t<view class=\"wx-login-item\">\n\t\t\t\t\t\t<text class=\"wx-login-label\">输入昵称</text>\n\t\t\t\t\t\t<!-- #ifdef MP-WEIXIN -->\n\t\t\t\t\t\t<input \n\t\t\t\t\t\t\tclass=\"wx-nickname-input\" \n\t\t\t\t\t\t\ttype=\"nickname\" \n\t\t\t\t\t\t\tv-model=\"tempNickname\" \n\t\t\t\t\t\t\tplaceholder=\"请输入昵称\"\n\t\t\t\t\t\t\tmaxlength=\"20\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<!-- #endif -->\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"modal-actions\">\n\t\t\t\t\t<button size=\"mini\" @click=\"closeWxLoginModal\">取消</button>\n\t\t\t\t\t<button size=\"mini\" type=\"primary\" @click=\"confirmWxLogin\">确认登录</button>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<view class=\"bottom-space\" />\n\t</view>\n</template>\n\n<script>\nimport { gameRecordService, userService } from '@/utils/supabase-helper.js'\n\nexport default {\n\t\tdata() {\n\t\t\treturn {\n\t\t\t\tuserId: '',\n\t\t\t\twxOpenid: '',\n\t\t\t\tnickname: '',\n\t\t\t\tavatar: '/static/user.png',\n\t\t\t\tstats: {\n\t\t\t\t\ttotalGames: 0,\n\t\t\t\t\tsuccessCount: 0,\n\t\t\t\t\tsuccessRate: 0,\n\t\t\t\t\tuniqueScenes: 0\n\t\t\t\t},\n\t\t\t\trecords: [],\n\t\t\t\tshowBottomSheet: false,\n\t\t\t\tbottomSheetTitle: '',\n\t\t\t\tbottomSheetOptions: [],\n\t\t\tselectedAvatar: '', // 已选择的头像\n\t\t\tshowNameInput: false,\n\t\t\tinputName: '',\n\t\t\tloginType: 'guest', // 登录类型：wx 或 guest\n\t\t\tshowWxLoginModal: false, // 微信一键登录弹窗\n\t\t\ttempAvatar: '', // 临时头像（选择后）\n\t\t\ttempNickname: '' // 临时昵称（输入后）\n\t\t\t}\n\t\t},\n\tonShow() {\n\t\tthis.loadUser()\n\t\tthis.loadStats()\n\t\tthis.loadRecords()\n\t\tif (!this.userId || !this.nickname || !this.avatar) {\n\t\t\tthis.promptLogin()\n\t\t}\n\t},\n\t// #ifdef MP-WEIXIN\n\tonShareAppMessage() {\n\t\tconst stats = this.stats\n\t\tconst shareTitle = stats.totalGames > 0\n\t\t\t? `我的挑战数据：总挑战${stats.totalGames}次，成功率${stats.successRate}%！来挑战吧！`\n\t\t\t: '哄一哄他（她）- AI情感对话游戏，挑战你的沟通技巧！'\n\t\t\n\t\treturn {\n\t\t\ttitle: shareTitle,\n\t\t\tpath: '/pages/index/index',\n\t\t\timageUrl: '' // 可选：分享图片，建议尺寸 5:4\n\t\t}\n\t},\n\tonShareTimeline() {\n\t\tconst stats = this.stats\n\t\tconst shareTitle = stats.totalGames > 0\n\t\t\t? `我的挑战数据：总挑战${stats.totalGames}次，成功率${stats.successRate}%！来挑战吧！`\n\t\t\t: '哄一哄他（她）- AI情感对话游戏，挑战你的沟通技巧！'\n\t\t\n\t\treturn {\n\t\t\ttitle: shareTitle,\n\t\t\tquery: '',\n\t\t\timageUrl: '' // 可选：分享图片，建议尺寸 1:1（500x500px）\n\t\t}\n\t},\n\t// #endif\n\tmethods: {\n\t\tloadUser() {\n\t\t\tconst storedId = uni.getStorageSync('userId') || ''\n\t\t\tconst storedName = uni.getStorageSync('userName') || ''\n\t\t\tconst storedAvatar = uni.getStorageSync('userAvatar') || ''\n\t\t\tconst storedWxOpenid = uni.getStorageSync('wxOpenid') || ''\n\t\t\t// 优先使用已存的 openid 作为 userId，确保身份稳定\n\t\t\tthis.userId = storedWxOpenid || storedId || this.genAnonId()\n\t\t\tthis.wxOpenid = storedWxOpenid || ''\n\t\t\tthis.nickname = storedName || ''\n\t\t\tif (storedAvatar) this.avatar = storedAvatar\n\t\t},\n\t\tasync saveUser(extra = {}) {\n\t\t\t// 保存到本地存储\n\t\t\tconst finalUserId = this.wxOpenid || this.userId || this.genAnonId()\n\t\t\tuni.setStorageSync('userId', finalUserId)\n\t\t\tuni.setStorageSync('userName', this.nickname || '')\n\t\t\tuni.setStorageSync('userAvatar', this.avatar || '/static/user.png')\n\t\t\tuni.setStorageSync('loginType', this.loginType || 'guest')\n\t\t\tif (extra.wxOpenid || this.wxOpenid) {\n\t\t\t\tuni.setStorageSync('wxOpenid', extra.wxOpenid || this.wxOpenid)\n\t\t\t}\n\t\t\t\n\t\t\t// 保存到 Supabase 数据库\n\t\t\ttry {\n\t\t\t\tconst { data, error } = await userService.createOrUpdateUser({\n\t\t\t\t\tuserId: finalUserId,\n\t\t\t\t\tnickname: this.nickname,\n\t\t\t\t\tavatarUrl: this.avatar !== '/static/user.png' ? this.avatar : null,\n\t\t\t\t\tloginType: this.loginType || 'guest',\n\t\t\t\t\twxOpenid: extra.wxOpenid || this.wxOpenid || null\n\t\t\t\t})\n\t\t\t\t\n\t\t\t\tif (error) {\n\t\t\t\t\tconsole.error('保存用户信息到数据库失败:', error)\n\t\t\t\t\t// 即使数据库保存失败，本地存储已成功，仍然提示成功\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error('保存用户信息异常:', err)\n\t\t\t}\n\t\t\t\n\t\t\tuni.showToast({ title: '已保存', icon: 'success' })\n\t\t},\n\t\tgenAnonId() {\n\t\t\tconst id = `guest-${Math.random().toString(16).slice(2, 10)}`\n\t\t\tthis.userId = id\n\t\t\treturn id\n\t\t},\n\t\tpromptLogin() {\n\t\t\tthis.bottomSheetTitle = '选择登录方式'\n\t\t\tthis.bottomSheetOptions = [\n\t\t\t\t{ text: '微信一键登录', type: 'wx-new' },\n\t\t\t\t{ text: '手动填写', type: 'manual' }\n\t\t\t]\n\t\t\tthis.showBottomSheet = true\n\t\t},\n\t\thandleBottomOption(index) {\n\t\t\tconst option = this.bottomSheetOptions[index]\n\t\t\tif (option.type === 'wx-new') {\n\t\t\t\t// 使用新的组件方式登录\n\t\t\t\tthis.closeBottomSheet()\n\t\t\t\tthis.showWxLoginModal = true\n\t\t\t} else if (option.type === 'wx') {\n\t\t\t\t// 旧的 getUserProfile 方式（已废弃，保留兼容）\n\t\t\t\tthis.wxAuthorize()\n\t\t\t\tthis.closeBottomSheet()\n\t\t\t} else if (option.type === 'manual') {\n\t\t\t\t// 切换到手动填写选项\n\t\t\t\tthis.showManualOptions()\n\t\t\t} else if (option.type === 'avatar') {\n\t\t\t\tthis.chooseAvatarFromAlbum()\n\t\t\t} else if (option.type === 'name') {\n\t\t\t\tthis.closeBottomSheet()\n\t\t\t\tthis.showNameInput = true\n\t\t\t}\n\t\t},\n\t\tshowManualOptions() {\n\t\t\tthis.bottomSheetTitle = '手动填写资料'\n\t\t\tthis.bottomSheetOptions = [\n\t\t\t\t{ \n\t\t\t\t\ttext: this.selectedAvatar ? '已选择头像' : '从相册选择头像', \n\t\t\t\t\ttype: 'avatar',\n\t\t\t\t\tavatar: this.selectedAvatar || null\n\t\t\t\t},\n\t\t\t\t{ text: '输入昵称', type: 'name' }\n\t\t\t]\n\t\t\t// 不关闭，直接更新选项\n\t\t},\n\t\tcloseBottomSheet() {\n\t\t\tthis.showBottomSheet = false\n\t\t\tthis.bottomSheetTitle = ''\n\t\t\tthis.bottomSheetOptions = []\n\t\t},\n\t\twxAuthorize() {\n\t\t\t// #ifdef MP-WEIXIN\n\t\t\tthis.wxAuthorizeAndBind()\n\t\t\t// #endif\n\t\t\t// #ifndef MP-WEIXIN\n\t\t\tuni.showToast({ title: '仅支持微信小程序', icon: 'none' })\n\t\t\t// #endif\n\t\t},\n\t\t// 微信授权 + 云函数 login 获取 openid + 同步到数据库\n\t\tasync wxAuthorizeAndBind() {\n\t\t\ttry {\n\t\t\t\tconst profile = await new Promise((resolve, reject) => {\n\t\t\tuni.getUserProfile({\n\t\t\t\tdesc: '用于完善个人资料',\n\t\t\t\t\t\tsuccess: (res) => resolve(res.userInfo || {}),\n\t\t\t\t\t\tfail: reject\n\t\t\t\t\t})\n\t\t\t\t})\n\n\t\t\t\tconst openid = await this.ensureWxOpenid()\n\t\t\t\tthis.wxOpenid = openid\n\t\t\t\t// 使用 openid 作为 userId，避免重复记录\n\t\t\t\tthis.userId = openid\n\t\t\t\tthis.nickname = profile.nickName || this.nickname\n\t\t\t\tthis.avatar = profile.avatarUrl || this.avatar\n\t\t\t\t\t\tthis.loginType = 'wx'\n\n\t\t\t\tawait this.saveUser({ wxOpenid: openid })\n\t\t\t\t\t\tthis.closeBottomSheet()\n\t\t\t\tuni.showToast({ title: '登录成功', icon: 'success' })\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error('微信授权失败', err)\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: err?.errMsg || '授权失败',\n\t\t\t\t\t\ticon: 'none'\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t},\n\t\t// 调用云函数 login 获取 openid\n\t\tgetWxOpenid() {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t// #ifdef MP-WEIXIN\n\t\t\t\tif (!wx.cloud) {\n\t\t\t\t\treject(new Error('wx.cloud 未初始化'))\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\twx.cloud.callFunction({\n\t\t\t\t\tname: 'login',\n\t\t\t\t\tsuccess: (res) => {\n\t\t\t\t\t\tconst openid = res?.result?.openid\n\t\t\t\t\t\tif (openid) resolve(openid)\n\t\t\t\t\t\telse reject(new Error('未获取到 openid'))\n\t\t\t\t\t},\n\t\t\t\t\tfail: reject\n\t\t\t})\n\t\t\t// #endif\n\t\t\t// #ifndef MP-WEIXIN\n\t\t\t\treject(new Error('仅支持微信小程序'))\n\t\t\t// #endif\n\t\t\t})\n\t\t},\n\t\t// 确保拿到 openid；拿不到时回退为 guest\n\t\tasync ensureWxOpenid() {\n\t\t\tif (this.wxOpenid) return this.wxOpenid\n\t\t\ttry {\n\t\t\t\tconst openid = await this.getWxOpenid()\n\t\t\t\tthis.wxOpenid = openid\n\t\t\t\tthis.userId = openid\n\t\t\t\tthis.loginType = 'wx'\n\t\t\t\tuni.setStorageSync('wxOpenid', openid)\n\t\t\t\treturn openid\n\t\t\t} catch (err) {\n\t\t\t\t// 无法获取 openid 时回退 guest，但会造成新用户；日志提示\n\t\t\t\tconsole.warn('获取 openid 失败，回退 guest：', err)\n\t\t\t\tthis.loginType = 'guest'\n\t\t\t\treturn null\n\t\t\t}\n\t\t},\n\t\tchangeAvatar() {\n\t\t\t// 个人中心页面头像不可点击编辑\n\t\t},\n\t\tasync chooseAvatarFromAlbum() {\n\t\t\tuni.chooseImage({\n\t\t\t\tcount: 1,\n\t\t\t\tsizeType: ['compressed'],\n\t\t\t\tsourceType: ['album'],\n\t\t\t\tsuccess: async (res) => {\n\t\t\t\t\tif (res.tempFilePaths && res.tempFilePaths.length > 0) {\n\t\t\t\t\t\tthis.selectedAvatar = res.tempFilePaths[0]\n\t\t\t\t\t\tthis.avatar = res.tempFilePaths[0]\n\t\t\t\t\t\t// 更新底部选择中的头像显示\n\t\t\t\t\t\tthis.showManualOptions()\n\t\t\t\t\t\t// 如果昵称也有了，自动保存并关闭\n\t\t\t\t\t\tif (this.nickname) {\n\t\t\t\t\t\t\tconst openid = await this.ensureWxOpenid()\n\t\t\t\t\t\t\tif (openid) {\n\t\t\t\t\t\t\t\tthis.userId = openid\n\t\t\t\t\t\t\t\tthis.loginType = 'wx'\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.loginType = 'guest'\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tawait this.saveUser({ wxOpenid: openid || null })\n\t\t\t\t\t\t\tthis.closeBottomSheet()\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// 头像已选，提示填写昵称\n\t\t\t\t\t\t\tuni.showToast({ title: '头像已选择，请填写昵称', icon: 'none' })\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t},\n\t\t// 微信一键登录相关方法\n\t\tonChooseAvatar(e) {\n\t\t\t// #ifdef MP-WEIXIN\n\t\t\tconst { avatarUrl } = e.detail\n\t\t\tif (avatarUrl) {\n\t\t\t\tthis.tempAvatar = avatarUrl\n\t\t\t}\n\t\t\t// #endif\n\t\t},\n\t\tcloseWxLoginModal() {\n\t\t\tthis.showWxLoginModal = false\n\t\t\tthis.tempAvatar = ''\n\t\t\tthis.tempNickname = ''\n\t\t},\n\t\tasync confirmWxLogin() {\n\t\t\t// #ifdef MP-WEIXIN\n\t\t\tif (!this.tempNickname || !this.tempNickname.trim()) {\n\t\t\t\tuni.showToast({ title: '请输入昵称', icon: 'none' })\n\t\t\t\treturn\n\t\t\t}\n\t\t\t\n\t\t\tif (!this.tempAvatar) {\n\t\t\t\tuni.showToast({ title: '请选择头像', icon: 'none' })\n\t\t\t\treturn\n\t\t\t}\n\t\t\t\n\t\t\ttry {\n\t\t\t\t// 1. 获取 openid\n\t\t\t\tconst openid = await this.getWxOpenid()\n\t\t\t\tif (!openid) {\n\t\t\t\t\tuni.showToast({ title: '获取用户信息失败', icon: 'none' })\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// 2. 设置用户信息\n\t\t\t\tthis.wxOpenid = openid\n\t\t\t\tthis.userId = openid\n\t\t\t\tthis.nickname = this.tempNickname.trim()\n\t\t\t\tthis.avatar = this.tempAvatar\n\t\t\t\tthis.loginType = 'wx'\n\t\t\t\t\n\t\t\t\t// 3. 保存到数据库和本地存储\n\t\t\t\tawait this.saveUser({ wxOpenid: openid })\n\t\t\t\t\n\t\t\t\t// 4. 关闭弹窗\n\t\t\t\tthis.closeWxLoginModal()\n\t\t\t\tuni.showToast({ title: '登录成功', icon: 'success' })\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error('微信一键登录失败:', err)\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: err?.message || '登录失败，请重试',\n\t\t\t\t\ticon: 'none'\n\t\t\t\t})\n\t\t\t}\n\t\t\t// #endif\n\t\t},\n\t\tcloseNameInput() {\n\t\t\tthis.showNameInput = false\n\t\t\tthis.inputName = ''\n\t\t},\n\t\tasync confirmNameInput() {\n\t\t\tif (!this.inputName.trim()) {\n\t\t\t\tuni.showToast({ title: '请输入昵称', icon: 'none' })\n\t\t\t\treturn\n\t\t\t}\n\t\t\tthis.nickname = this.inputName.trim()\n\t\t\t// 尝试获取 openid，让手动填写也绑定同一身份\n\t\t\tconst openid = await this.ensureWxOpenid()\n\t\t\tif (openid) {\n\t\t\t\tthis.userId = openid\n\t\t\t\tthis.loginType = 'wx'\n\t\t\t} else {\n\t\t\tthis.loginType = 'guest'\n\t\t\t}\n\t\t\t// 如果头像也有了，自动保存\n\t\t\tif (this.selectedAvatar) {\n\t\t\t\tthis.avatar = this.selectedAvatar\n\t\t\t\tawait this.saveUser({ wxOpenid: openid || null })\n\t\t\t} else {\n\t\t\t\t// 昵称已填，提示选择头像\n\t\t\t\tuni.showToast({ title: '昵称已保存，请选择头像', icon: 'none' })\n\t\t\t\t// 重新打开底部选择，显示手动填写选项\n\t\t\t\tthis.showManualOptions()\n\t\t\t\tthis.showBottomSheet = true\n\t\t\t}\n\t\t\tthis.closeNameInput()\n\t\t},\n\t\tasync loadStats() {\n\t\t\tif (!this.userId) return\n\t\t\tconst { data, error } = await gameRecordService.getUserStats(this.userId)\n\t\t\tif (!error && data) {\n\t\t\t\tthis.stats = data\n\t\t\t}\n\t\t},\n\t\tasync loadRecords() {\n\t\t\tif (!this.userId) return\n\t\t\tconst { data, error } = await gameRecordService.getRecentScenes(this.userId, 5)\n\t\t\tif (!error && data) {\n\t\t\t\tthis.records = data.map(r => ({\n\t\t\t\t\t...r,\n\t\t\t\t\tsceneTitle: (r.scene && r.scene.title) || r.scene_title || r.sceneId || '场景'\n\t\t\t\t}))\n\t\t\t}\n\t\t},\n\t\thandleRecordClick(rec) {\n\t\t\tconst sceneId = rec.scene_id || rec.sceneId\n\t\t\tif (!sceneId) {\n\t\t\t\tuni.showToast({ title: '缺少场景ID', icon: 'none' })\n\t\t\t\treturn\n\t\t\t}\n\t\t\tuni.navigateTo({ url: `/pages/dialog/dialog?id=${sceneId}` })\n\t\t},\n\t\tclearUserData() {\n\t\t\tuni.showModal({\n\t\t\t\ttitle: '提示',\n\t\t\t\tcontent: '确定要清除登录信息吗？清除后需要重新登录',\n\t\t\t\tsuccess: (res) => {\n\t\t\t\t\tif (res.confirm) {\n\t\t\t\t\t// 清除本地存储\n\t\t\t\t\tuni.removeStorageSync('userId')\n\t\t\t\t\tuni.removeStorageSync('userName')\n\t\t\t\t\tuni.removeStorageSync('userAvatar')\n\t\t\t\t\tuni.removeStorageSync('loginType')\n\t\t\t\t\tuni.removeStorageSync('wxOpenid')\n\t\t\t\t\t// 重置数据\n\t\t\t\t\tthis.userId = ''\n\t\t\t\t\tthis.wxOpenid = ''\n\t\t\t\t\tthis.nickname = ''\n\t\t\t\t\tthis.avatar = '/static/user.png'\n\t\t\t\t\tthis.selectedAvatar = ''\n\t\t\t\t\tthis.loginType = 'guest'\n\t\t\t\t\tthis.stats = {\n\t\t\t\t\t\ttotalGames: 0,\n\t\t\t\t\t\tsuccessCount: 0,\n\t\t\t\t\t\tsuccessRate: 0,\n\t\t\t\t\t\tuniqueScenes: 0\n\t\t\t\t\t}\n\t\t\t\t\tthis.records = []\n\t\t\t\t\t// 弹出登录选择\n\t\t\t\t\tthis.promptLogin()\n\t\t\t\t\tuni.showToast({ title: '已清除，请重新登录', icon: 'success' })\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}\n}\n</script>\n\n<style>\n.page {\n\tmin-height: 100vh;\n\tbackground: #f5f6fa;\n\tpadding: 20rpx 20rpx 40rpx 20rpx;\n\tbox-sizing: border-box;\n}\n\n.profile-card {\n\tbackground: #fff;\n\tborder-radius: 0;\n\tpadding: 30rpx 24rpx;\n\tmargin-bottom: 20rpx;\n\tdisplay: flex;\n\talign-items: center;\n\tposition: relative;\n}\n\n.avatar {\n\twidth: 120rpx;\n\theight: 120rpx;\n\tborder-radius: 12rpx;\n\tbackground: #f0f0f0;\n\tmargin-right: 24rpx;\n\tflex-shrink: 0;\n}\n\n.profile-info {\n\tflex: 1;\n\tdisplay: flex;\n\talign-items: center;\n}\n\n.name {\n\tfont-size: 36rpx;\n\tfont-weight: 500;\n\tcolor: #333;\n}\n\n.clear-btn {\n\tposition: absolute;\n\ttop: 30rpx;\n\tright: 24rpx;\n\tpadding: 8rpx 16rpx;\n\tbackground: #f5f5f5;\n\tborder: 1rpx solid #e0e0e0;\n\tborder-radius: 8rpx;\n\tfont-size: 22rpx;\n\tcolor: #666;\n}\n\n.mini-btn {\n\tbackground: #1f2937;\n\tcolor: #fefefe;\n\tborder: 1rpx solid #2d3748;\n}\n\n.profile-actions {\n\tmargin-top: 16rpx;\n\tdisplay: flex;\n\tgap: 12rpx;\n}\n\n.action-btn {\n\tflex: 1;\n\tborder: 1rpx solid #2d3748;\n\tbackground: #1f2937;\n\tcolor: #fefefe;\n}\n\n.stats-card,\n.records-card {\n\tbackground: #fff;\n\tborder-radius: 16rpx;\n\tpadding: 20rpx;\n\tbox-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.04);\n\tmargin-bottom: 16rpx;\n}\n\n.stats-title,\n.records-title {\n\tfont-size: 30rpx;\n\tfont-weight: 600;\n\tcolor: #222;\n\tmargin-bottom: 12rpx;\n}\n\n.stats-row {\n\tdisplay: flex;\n\tjustify-content: space-between;\n\tgap: 12rpx;\n}\n\n.stat-item {\n\tflex: 1;\n\tbackground: #f8f9fb;\n\tborder-radius: 12rpx;\n\tpadding: 16rpx;\n\ttext-align: center;\n}\n\n.stat-value {\n\tfont-size: 32rpx;\n\tfont-weight: 700;\n\tcolor: #111;\n\tdisplay: block;\n\tmargin-bottom: 4rpx;\n}\n\n.stat-label {\n\tfont-size: 24rpx;\n\tcolor: #777;\n}\n\n.record-item {\n\tpadding: 20rpx 16rpx;\n\tborder: 1rpx solid #eef1f5;\n\tborder-radius: 14rpx;\n\tbackground: linear-gradient(180deg, #ffffff 0%, #f9fbff 100%);\n\tbox-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.04);\n\tmargin-bottom: 14rpx;\n\tdisplay: flex;\n\talign-items: center;\n\tgap: 16rpx;\n}\n\n.rec-top {\n\tdisplay: flex;\n\tjustify-content: space-between;\n\talign-items: center;\n\tmargin-bottom: 6rpx;\n\tgap: 12rpx;\n}\n\n.rec-title {\n\tfont-size: 28rpx;\n\tcolor: #222;\n\tfont-weight: 600;\n\tflex: 1;\n}\n\n.rec-result {\n\tfont-size: 24rpx;\n\tpadding: 4rpx 10rpx;\n\tborder-radius: 10rpx;\n\twhite-space: nowrap;\n}\n\n.rec-result.ok {\n\tbackground: #e6f6ef;\n\tcolor: #0f9d58;\n}\n\n.rec-result.fail {\n\tbackground: #fdecec;\n\tcolor: #d93025;\n}\n\n.rec-sub {\n\tfont-size: 24rpx;\n\tcolor: #777;\n\tdisplay: flex;\n\tgap: 20rpx;\n\tflex-wrap: wrap;\n}\n\n.empty {\n\tfont-size: 26rpx;\n\tcolor: #999;\n\tpadding: 12rpx 0;\n}\n\n.record-main {\n\tflex: 1;\n\tmin-width: 0;\n}\n\n.rec-action {\n\tdisplay: flex;\n\talign-items: center;\n\tgap: 6rpx;\n\tcolor: #4f46e5;\n\tfont-size: 26rpx;\n\tfont-weight: 600;\n\tpadding-left: 8rpx;\n}\n\n.rec-cta {\n\tline-height: 1;\n}\n\n.rec-arrow {\n\tfont-size: 32rpx;\n\tline-height: 1;\n}\n\n.bottom-space {\n\theight: 60rpx;\n}\n\n/* 底部选择弹窗 */\n.bottom-sheet-mask {\n\tposition: fixed;\n\ttop: 0;\n\tleft: 0;\n\tright: 0;\n\tbottom: 0;\n\tbackground: rgba(0, 0, 0, 0.5);\n\tz-index: 999;\n\tdisplay: flex;\n\talign-items: flex-end;\n}\n\n.bottom-sheet {\n\twidth: 100%;\n\tbackground: #fff;\n\tborder-radius: 24rpx 24rpx 0 0;\n\tpadding: 20rpx 0;\n\tanimation: slideUp 0.3s ease-out;\n}\n\n@keyframes slideUp {\n\tfrom {\n\t\ttransform: translateY(100%);\n\t}\n\tto {\n\t\ttransform: translateY(0);\n\t}\n}\n\n.sheet-title {\n\tfont-size: 28rpx;\n\tcolor: #999;\n\ttext-align: center;\n\tpadding: 0 20rpx 20rpx;\n}\n\n.sheet-options {\n\tpadding: 0 20rpx;\n}\n\n.sheet-option {\n\tdisplay: flex;\n\talign-items: center;\n\tpadding: 24rpx 0;\n\tborder-bottom: 1rpx solid #f0f0f0;\n}\n\n.sheet-option:last-child {\n\tborder-bottom: none;\n}\n\n.option-avatar {\n\twidth: 60rpx;\n\theight: 60rpx;\n\tborder-radius: 8rpx;\n\tmargin-right: 20rpx;\n}\n\n.option-text {\n\tfont-size: 32rpx;\n\tcolor: #333;\n}\n\n.sheet-cancel {\n\ttext-align: center;\n\tpadding: 24rpx 0;\n\tmargin-top: 20rpx;\n\tborder-top: 1rpx solid #f0f0f0;\n\tfont-size: 32rpx;\n\tcolor: #333;\n}\n\n/* 输入昵称弹窗 */\n.modal-mask {\n\tposition: fixed;\n\ttop: 0;\n\tleft: 0;\n\tright: 0;\n\tbottom: 0;\n\tbackground: rgba(0, 0, 0, 0.5);\n\tz-index: 1000;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n}\n\n.modal {\n\twidth: 600rpx;\n\tbackground: #fff;\n\tborder-radius: 16rpx;\n\tpadding: 40rpx;\n}\n\n.modal-title {\n\tfont-size: 32rpx;\n\tfont-weight: 600;\n\tcolor: #333;\n\tmargin-bottom: 30rpx;\n\ttext-align: center;\n}\n\n.modal-input {\n\twidth: 100%;\n\tpadding: 20rpx;\n\tborder: 1rpx solid #e0e0e0;\n\tborder-radius: 8rpx;\n\tfont-size: 28rpx;\n\tmargin-bottom: 30rpx;\n}\n\n.modal-actions {\n\tdisplay: flex;\n\tgap: 20rpx;\n\tjustify-content: flex-end;\n}\n\n/* 微信一键登录弹窗样式 */\n.wx-login-modal {\n\tmin-width: 600rpx;\n}\n\n.wx-login-content {\n\tpadding: 20rpx 0;\n}\n\n.wx-login-item {\n\tmargin-bottom: 30rpx;\n}\n\n.wx-login-label {\n\tfont-size: 28rpx;\n\tcolor: #333;\n\tfont-weight: 500;\n\tdisplay: block;\n\tmargin-bottom: 16rpx;\n}\n\n.wx-avatar-btn {\n\twidth: 100%;\n\theight: 200rpx;\n\tpadding: 0;\n\tbackground: #f5f5f5;\n\tborder: 2rpx dashed #ddd;\n\tborder-radius: 12rpx;\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\tposition: relative;\n\toverflow: hidden;\n}\n\n.wx-avatar-btn::after {\n\tborder: none;\n}\n\n.wx-avatar-preview {\n\twidth: 100%;\n\theight: 100%;\n\tborder-radius: 10rpx;\n}\n\n.wx-avatar-placeholder {\n\tfont-size: 26rpx;\n\tcolor: #999;\n}\n\n.wx-nickname-input {\n\twidth: 100%;\n\theight: 88rpx;\n\tbackground: #f5f5f5;\n\tborder-radius: 12rpx;\n\tpadding: 0 24rpx;\n\tfont-size: 28rpx;\n\tcolor: #333;\n\tbox-sizing: border-box;\n}\n</style>\n\n","import MiniProgramPage from 'D:/Hbuilder/HBuilderX.4.76.2025082103/project/first/pages/profile/profile.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","gameRecordService"],"mappings":"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"}