{"version":3,"file":"dialog.js","sources":["pages/dialog/dialog.vue","../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvZGlhbG9nL2RpYWxvZy52dWU"],"sourcesContent":["<template>\r\n\t<view class=\"dialog-page\">\r\n\t\t<!-- 头部信息 -->\r\n\t\t<view class=\"scene-header\" v-if=\"scene\">\r\n\t\t\t<view class=\"scene-title\">{{ scene.title }}</view>\r\n\t\t\t<view class=\"meta-row\">\r\n\t\t\t\t<view class=\"meta-item\">\r\n\t\t\t\t\t<text class=\"meta-label\">原谅值</text>\r\n\t\t\t\t\t<view class=\"bar\">\r\n\t\t\t\t\t\t<view class=\"bar-fill\" :style=\"{ width: forgivenessPercent + '%' }\"></view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t\t<text class=\"meta-value\">{{ forgiveness }}/100</text>\r\n\t\t\t\t</view>\r\n\t\t\t\t<view class=\"meta-item turns\">\r\n\t\t\t\t\t<text class=\"meta-label\">聊天轮次</text>\r\n\t\t\t\t\t<text class=\"meta-value\">{{ currentTurn }}/{{ maxTurns }}</text>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\r\n\t\t<!-- 聊天区 -->\r\n\t\t<scroll-view class=\"chat-list\" :scroll-y=\"true\" scroll-with-animation :scroll-into-view=\"lastMsgId\">\r\n\t\t\t<view\r\n\t\t\t\tv-for=\"(msg, idx) in messages\"\r\n\t\t\t\t:key=\"msg.id\"\r\n\t\t\t\t:id=\"msg.id\"\r\n\t\t\t\tclass=\"chat-item\"\r\n\t\t\t\t:class=\"msg.role\"\r\n\t\t\t>\r\n\t\t\t\t<image class=\"avatar\" :src=\"msg.role === 'ai' ? aiAvatar : userAvatar\" mode=\"aspectFill\" />\r\n\t\t\t\t<view class=\"bubble\">\r\n\t\t\t\t\t<text class=\"msg-text\">{{ msg.text }}</text>\r\n\t\t\t\t\t<text v-if=\"msg.forgivenessChange\" class=\"forgive-change\">{{ msg.forgivenessChange }}</text>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t</scroll-view>\r\n\r\n\t\t<!-- 输入区 -->\r\n\t\t<view class=\"input-area\">\r\n\t\t\t<input\r\n\t\t\t\tclass=\"text-input\"\r\n\t\t\t\tv-model=\"inputText\"\r\n\t\t\t\t:disabled=\"actionLocked\"\r\n\t\t\t\tplaceholder=\"快，说点什么\"\r\n\t\t\t\tconfirm-type=\"send\"\r\n\t\t\t\t@confirm=\"handleSend\"\r\n\t\t\t/>\r\n\t\t\t<button class=\"send-btn\" type=\"primary\" :disabled=\"actionLocked\" @click=\"handleSend\">发送</button>\r\n\t\t</view>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\nimport { sceneService } from '@/utils/supabase-helper.js'\r\n\r\nexport default {\r\n\tdata() {\r\n\t\treturn {\r\n\t\t\tsceneId: '',\r\n\t\t\tscene: null,\r\n\t\t\tloading: false,\r\n\t\t\tinputText: '',\r\n\t\t\tforgiveness: 0,\r\n\t\t\tmaxTurns: 10,\r\n\t\t\tcurrentTurn: 0,\r\n\t\t\tmessages: [],\r\n\t\t\tuserAvatar: 'https://cdn.uviewui.com/uview/common/user.png',\r\n\t\t\taiAvatar: 'https://cdn.uviewui.com/uview/common/logo.png',\r\n\t\t\tactionLocked: false,\r\n\t\t\tlastMsgId: ''\r\n\t\t}\r\n\t},\r\n\tcomputed: {\r\n\t\tforgivenessPercent() {\r\n\t\t\tconst val = Math.max(0, Math.min(100, this.forgiveness))\r\n\t\t\treturn val\r\n\t\t}\r\n\t},\r\n\tonLoad(options) {\r\n\t\tif (!options || !options.id) {\r\n\t\t\tuni.showToast({ title: '缺少场景ID', icon: 'none' })\r\n\t\t\treturn\r\n\t\t}\r\n\t\tthis.sceneId = options.id\r\n\t\tthis.initScene()\r\n\t},\r\n\tmethods: {\r\n\t\tasync initScene() {\r\n\t\t\tthis.loading = true\r\n\t\t\ttry {\r\n\t\t\t\tconst { data, error } = await sceneService.getSceneById(this.sceneId)\r\n\t\t\t\tif (error || !data) {\r\n\t\t\t\t\tuni.showToast({ title: '加载场景失败', icon: 'none' })\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\t\t\t\tthis.scene = data\r\n\t\t\t\tthis.forgiveness = data.initial_forgiveness || 20\r\n\t\t\t\tthis.maxTurns = data.max_interactions || 10\r\n\t\t\t\tthis.currentTurn = 0\r\n\t\t\t\tthis.messages = []\r\n\t\t\t\tthis.appendMessage('ai', data.angry_reason || data.title || '我现在很生气，你说说看。')\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconsole.error(err)\r\n\t\t\t\tuni.showToast({ title: '加载失败', icon: 'none' })\r\n\t\t\t} finally {\r\n\t\t\t\tthis.loading = false\r\n\t\t\t}\r\n\t\t},\r\n\t\tappendMessage(role, text, forgivenessChange = '') {\r\n\t\t\tconst id = `msg-${Date.now()}-${Math.random().toString(16).slice(2)}`\r\n\t\t\tthis.messages.push({ id, role, text, forgivenessChange })\r\n\t\t\tthis.lastMsgId = id\r\n\t\t},\r\n\t\thandleSend() {\r\n\t\t\tif (this.actionLocked) return\r\n\t\t\tconst content = this.inputText.trim()\r\n\t\t\tif (!content) {\r\n\t\t\t\tuni.showToast({ title: '请输入内容', icon: 'none' })\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\t\t\tthis.inputText = ''\r\n\t\t\tthis.currentTurn++\r\n\t\t\tthis.appendMessage('user', content)\r\n\t\t\tthis.actionLocked = true\r\n\t\t\t// 模拟 AI 回复和原谅值变化\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tconst delta = this.calcForgivenessDelta(content)\r\n\t\t\t\tthis.forgiveness = Math.max(0, Math.min(100, this.forgiveness + delta))\r\n\t\t\t\tconst changeText = delta >= 0 ? `原谅值 +${delta}` : `原谅值 ${delta}`\r\n\t\t\t\tconst reply = this.buildAiReply(delta)\r\n\t\t\t\tthis.appendMessage('ai', reply, changeText)\r\n\t\t\t\tthis.checkResult()\r\n\t\t\t\tthis.actionLocked = false\r\n\t\t\t}, 300)\r\n\t\t},\r\n\t\tcalcForgivenessDelta(text) {\r\n\t\t\t// 简单策略：含有“抱歉/对不起”正向，大写词负向，默认随机\r\n\t\t\tconst lower = text.toLowerCase()\r\n\t\t\tif (lower.includes('对不起') || lower.includes('抱歉') || lower.includes('sorry')) {\r\n\t\t\t\treturn this.randomInt(10, 25)\r\n\t\t\t}\r\n\t\t\tif (lower.includes('你错') || lower.includes('怪你')) {\r\n\t\t\t\treturn -this.randomInt(15, 30)\r\n\t\t\t}\r\n\t\t\treturn this.randomInt(-15, 20)\r\n\t\t},\r\n\t\tbuildAiReply(delta) {\r\n\t\t\tif (!this.scene) return '...'\r\n\t\t\tif (delta >= 15) return '好吧，态度还不错。'\r\n\t\t\tif (delta >= 5) return '嗯，勉强听进去一些。'\r\n\t\t\tif (delta >= 0) return '我再听听，你继续说。'\r\n\t\t\tif (delta >= -10) return '你这话让我有点生气。'\r\n\t\t\treturn '你是来气我的吗？'\r\n\t\t},\r\n\t\trandomInt(min, max) {\r\n\t\t\treturn Math.floor(Math.random() * (max - min + 1)) + min\r\n\t\t},\r\n\t\tcheckResult() {\r\n\t\t\tif (this.forgiveness >= 100) {\r\n\t\t\t\tthis.forgiveness = 100\r\n\t\t\t\tthis.showResult(true)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\t\t\tif (this.forgiveness <= 0) {\r\n\t\t\t\tthis.forgiveness = 0\r\n\t\t\t\tthis.showResult(false)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\t\t\tif (this.currentTurn >= this.maxTurns) {\r\n\t\t\t\tthis.showResult(false, '已用完所有对话次数')\r\n\t\t\t}\r\n\t\t},\r\n\t\tshowResult(success, reason = '') {\r\n\t\t\tthis.actionLocked = true\r\n\t\t\tconst title = success ? '恭喜，哄好了！' : '挑战失败'\r\n\t\t\tconst content = success\r\n\t\t\t\t? `原谅值达到 100，胜利！`\r\n\t\t\t\t: reason || `原谅值 ${this.forgiveness}，挑战失败`\r\n\t\t\tuni.showModal({\r\n\t\t\t\ttitle,\r\n\t\t\t\tcontent,\r\n\t\t\t\tconfirmText: '重新挑战',\r\n\t\t\t\tcancelText: '返回首页',\r\n\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\tif (res.confirm) {\r\n\t\t\t\t\t\tthis.actionLocked = false\r\n\t\t\t\t\t\tthis.initScene()\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tuni.reLaunch({ url: '/pages/index/index' })\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}\r\n\t}\r\n}\r\n</script>\r\n\r\n<style>\r\n.dialog-page {\r\n\tmin-height: 100vh;\r\n\tbackground-color: #f5f6fa;\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n}\r\n\r\n.scene-header {\r\n\tpadding: 20rpx 24rpx 0 24rpx;\r\n}\r\n\r\n.scene-title {\r\n\tfont-size: 32rpx;\r\n\tfont-weight: 700;\r\n\tcolor: #222;\r\n\tmargin-bottom: 12rpx;\r\n}\r\n\r\n.meta-row {\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n\tgap: 20rpx;\r\n}\r\n\r\n.meta-item {\r\n\tflex: 1;\r\n}\r\n\r\n.meta-label {\r\n\tfont-size: 24rpx;\r\n\tcolor: #666;\r\n\tmargin-bottom: 8rpx;\r\n\tdisplay: block;\r\n}\r\n\r\n.bar {\r\n\twidth: 100%;\r\n\theight: 12rpx;\r\n\tbackground: #e5e7eb;\r\n\tborder-radius: 12rpx;\r\n\toverflow: hidden;\r\n}\r\n\r\n.bar-fill {\r\n\theight: 100%;\r\n\tbackground: #ff6b6b;\r\n}\r\n\r\n.meta-value {\r\n\tfont-size: 24rpx;\r\n\tcolor: #333;\r\n\tmargin-top: 6rpx;\r\n\tdisplay: inline-block;\r\n}\r\n\r\n.turns {\r\n\tflex: 0 0 180rpx;\r\n\ttext-align: right;\r\n}\r\n\r\n.chat-list {\r\n\tflex: 1;\r\n\tpadding: 20rpx 16rpx 140rpx 16rpx;\r\n}\r\n\r\n.chat-item {\r\n\tdisplay: flex;\r\n\tmargin-bottom: 20rpx;\r\n}\r\n\r\n.chat-item.user {\r\n\tflex-direction: row-reverse;\r\n}\r\n\r\n.avatar {\r\n\twidth: 64rpx;\r\n\theight: 64rpx;\r\n\tborder-radius: 50%;\r\n\tmargin: 0 12rpx;\r\n\tbackground: #ddd;\r\n}\r\n\r\n.bubble {\r\n\tmax-width: 80%;\r\n\tpadding: 18rpx 20rpx;\r\n\tborder-radius: 20rpx;\r\n\tbackground: #fff;\r\n\tbox-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.04);\r\n\tcolor: #333;\r\n\tfont-size: 28rpx;\r\n\tline-height: 40rpx;\r\n}\r\n\r\n.chat-item.user .bubble {\r\n\tbackground: #4f46e5;\r\n\tcolor: #fff;\r\n}\r\n\r\n.msg-text {\r\n\tdisplay: block;\r\n}\r\n\r\n.forgive-change {\r\n\tdisplay: block;\r\n\tmargin-top: 8rpx;\r\n\tfont-size: 24rpx;\r\n\tcolor: #888;\r\n}\r\n\r\n.chat-item.user .forgive-change {\r\n\tcolor: #e5e7eb;\r\n}\r\n\r\n.input-area {\r\n\tposition: fixed;\r\n\tleft: 0;\r\n\tright: 0;\r\n\tbottom: 0;\r\n\tpadding: 12rpx 16rpx;\r\n\tbackground: #fff;\r\n\tbox-shadow: 0 -4rpx 10rpx rgba(0, 0, 0, 0.06);\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n\tgap: 12rpx;\r\n}\r\n\r\n.text-input {\r\n\tflex: 1;\r\n\theight: 88rpx;\r\n\tbackground: #f5f5f5;\r\n\tborder-radius: 12rpx;\r\n\tpadding: 0 16rpx;\r\n\tfont-size: 28rpx;\r\n}\r\n\r\n.send-btn {\r\n\theight: 88rpx;\r\n\tline-height: 88rpx;\r\n\tpadding: 0 32rpx;\r\n\tfont-size: 28rpx;\r\n\tborder-radius: 12rpx;\r\n\tbackground: linear-gradient(135deg, #4f46e5, #7c3aed);\r\n\tborder: none;\r\n}\r\n</style>\r\n\r\n","import MiniProgramPage from 'D:/Hbuilder/HBuilderX.4.76.2025082103/project/first/pages/dialog/dialog.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","sceneService"],"mappings":"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"}